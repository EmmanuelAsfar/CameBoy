#include "mmu.h"
#include "cpu.h"

// ============================================================================
// TABLES D'OPCODES COMPLÈTES
// ============================================================================

// Table d'opcodes de base (256 instructions)
const Instruction opcodes[256] = {
    // 0x00-0x0F
    [0x00] = {"NOP", 1, 4, 0, inst_nop},
    [0x01] = {"LD BC, nn", 3, 12, 0, inst_ld_r16_n16},
    [0x02] = {"LD (BC), A", 1, 8, 0, inst_ld_bc_a},
    [0x03] = {"INC BC", 1, 8, 0, inst_inc_r16},
    [0x04] = {"INC B", 1, 4, 0, inst_inc_r8},
    [0x05] = {"DEC B", 1, 4, 0, inst_dec_r8},
    [0x06] = {"LD B, n", 2, 8, 0, inst_ld_r8_n8},
    [0x07] = {"RLCA", 1, 4, 0, inst_rlca},
    [0x08] = {"LD (nn), SP", 3, 20, 0, inst_ld_nn_sp},
    [0x09] = {"ADD HL, BC", 1, 8, 0, inst_add_hl_r16},
    [0x0A] = {"LD A, (BC)", 1, 8, 0, inst_ld_a_bc},
    [0x0B] = {"DEC BC", 1, 8, 0, inst_dec_r16},
    [0x0C] = {"INC C", 1, 4, 0, inst_inc_r8},
    [0x0D] = {"DEC C", 1, 4, 0, inst_dec_r8},
    [0x0E] = {"LD C, n", 2, 8, 0, inst_ld_r8_n8},
    [0x0F] = {"RRCA", 1, 4, 0, inst_rrca},
    
    // 0x10-0x1F
    [0x10] = {"STOP", 1, 4, 0, inst_stop},
    [0x11] = {"LD DE, nn", 3, 12, 0, inst_ld_r16_n16},
    [0x12] = {"LD (DE), A", 1, 8, 0, inst_ld_de_a},
    [0x13] = {"INC DE", 1, 8, 0, inst_inc_r16},
    [0x14] = {"INC D", 1, 4, 0, inst_inc_r8},
    [0x15] = {"DEC D", 1, 4, 0, inst_dec_r8},
    [0x16] = {"LD D, n", 2, 8, 0, inst_ld_r8_n8},
    [0x17] = {"RLA", 1, 4, 0, inst_rla},
    [0x18] = {"JR e", 2, 12, 0, inst_jr_e8},
    [0x19] = {"ADD HL, DE", 1, 8, 0, inst_add_hl_r16},
    [0x1A] = {"LD A, (DE)", 1, 8, 0, inst_ld_a_de},
    [0x1B] = {"DEC DE", 1, 8, 0, inst_dec_r16},
    [0x1C] = {"INC E", 1, 4, 0, inst_inc_r8},
    [0x1D] = {"DEC E", 1, 4, 0, inst_dec_r8},
    [0x1E] = {"LD E, n", 2, 8, 0, inst_ld_r8_n8},
    [0x1F] = {"RRA", 1, 4, 0, inst_rra},
    
    // 0x20-0x2F
    [0x20] = {"JR NZ, e", 2, 12, 8, inst_jr_nz_e8},
    [0x21] = {"LD HL, nn", 3, 12, 0, inst_ld_r16_n16},
    [0x22] = {"LD (HL+), A", 1, 8, 0, inst_ld_hl_plus_a},
    [0x23] = {"INC HL", 1, 8, 0, inst_inc_r16},
    [0x24] = {"INC H", 1, 4, 0, inst_inc_r8},
    [0x25] = {"DEC H", 1, 4, 0, inst_dec_r8},
    [0x26] = {"LD H, n", 2, 8, 0, inst_ld_r8_n8},
    [0x27] = {"DAA", 1, 4, 0, inst_daa},
    [0x28] = {"JR Z, e", 2, 12, 8, inst_jr_z_e8},
    [0x29] = {"ADD HL, HL", 1, 8, 0, inst_add_hl_r16},
    [0x2A] = {"LD A, (HL+)", 1, 8, 0, inst_ld_a_hl_plus},
    [0x2B] = {"DEC HL", 1, 8, 0, inst_dec_r16},
    [0x2C] = {"INC L", 1, 4, 0, inst_inc_r8},
    [0x2D] = {"DEC L", 1, 4, 0, inst_dec_r8},
    [0x2E] = {"LD L, n", 2, 8, 0, inst_ld_r8_n8},
    [0x2F] = {"CPL", 1, 4, 0, inst_cpl},
    
    // 0x30-0x3F
    [0x30] = {"JR NC, e", 2, 12, 8, inst_jr_nc_e8},
    [0x31] = {"LD SP, nn", 3, 12, 0, inst_ld_sp_n16},
    [0x32] = {"LD (HL-), A", 1, 8, 0, inst_ld_hl_minus_a},
    [0x33] = {"INC SP", 1, 8, 0, inst_inc_r16},
    [0x34] = {"INC (HL)", 1, 12, 0, inst_inc_r8},
    [0x35] = {"DEC (HL)", 1, 12, 0, inst_dec_r8},
    [0x36] = {"LD (HL), n", 2, 12, 0, inst_ld_r8_n8},
    [0x37] = {"SCF", 1, 4, 0, inst_scf},
    [0x38] = {"JR C, e", 2, 12, 8, inst_jr_c_e8},
    [0x39] = {"ADD HL, SP", 1, 8, 0, inst_add_hl_r16},
    [0x3A] = {"LD A, (HL-)", 1, 8, 0, inst_ld_a_hl_minus},
    [0x3B] = {"DEC SP", 1, 8, 0, inst_dec_r16},
    [0x3C] = {"INC A", 1, 4, 0, inst_inc_r8},
    [0x3D] = {"DEC A", 1, 4, 0, inst_dec_r8},
    [0x3E] = {"LD A, n", 2, 8, 0, inst_ld_r8_n8},
    [0x3F] = {"CCF", 1, 4, 0, inst_ccf},
    
    // 0x40-0x4F - LD r, r
    [0x40] = {"LD B, B", 1, 4, 0, inst_ld_r8_r8},
    [0x41] = {"LD B, C", 1, 4, 0, inst_ld_r8_r8},
    [0x42] = {"LD B, D", 1, 4, 0, inst_ld_r8_r8},
    [0x43] = {"LD B, E", 1, 4, 0, inst_ld_r8_r8},
    [0x44] = {"LD B, H", 1, 4, 0, inst_ld_r8_r8},
    [0x45] = {"LD B, L", 1, 4, 0, inst_ld_r8_r8},
    [0x46] = {"LD B, (HL)", 1, 8, 0, inst_ld_r8_r8},
    [0x47] = {"LD B, A", 1, 4, 0, inst_ld_r8_r8},
    [0x48] = {"LD C, B", 1, 4, 0, inst_ld_r8_r8},
    [0x49] = {"LD C, C", 1, 4, 0, inst_ld_r8_r8},
    [0x4A] = {"LD C, D", 1, 4, 0, inst_ld_r8_r8},
    [0x4B] = {"LD C, E", 1, 4, 0, inst_ld_r8_r8},
    [0x4C] = {"LD C, H", 1, 4, 0, inst_ld_r8_r8},
    [0x4D] = {"LD C, L", 1, 4, 0, inst_ld_r8_r8},
    [0x4E] = {"LD C, (HL)", 1, 8, 0, inst_ld_r8_r8},
    [0x4F] = {"LD C, A", 1, 4, 0, inst_ld_r8_r8},
    
    // 0x50-0x5F - LD r, r
    [0x50] = {"LD D, B", 1, 4, 0, inst_ld_r8_r8},
    [0x51] = {"LD D, C", 1, 4, 0, inst_ld_r8_r8},
    [0x52] = {"LD D, D", 1, 4, 0, inst_ld_r8_r8},
    [0x53] = {"LD D, E", 1, 4, 0, inst_ld_r8_r8},
    [0x54] = {"LD D, H", 1, 4, 0, inst_ld_r8_r8},
    [0x55] = {"LD D, L", 1, 4, 0, inst_ld_r8_r8},
    [0x56] = {"LD D, (HL)", 1, 8, 0, inst_ld_r8_r8},
    [0x57] = {"LD D, A", 1, 4, 0, inst_ld_r8_r8},
    [0x58] = {"LD E, B", 1, 4, 0, inst_ld_r8_r8},
    [0x59] = {"LD E, C", 1, 4, 0, inst_ld_r8_r8},
    [0x5A] = {"LD E, D", 1, 4, 0, inst_ld_r8_r8},
    [0x5B] = {"LD E, E", 1, 4, 0, inst_ld_r8_r8},
    [0x5C] = {"LD E, H", 1, 4, 0, inst_ld_r8_r8},
    [0x5D] = {"LD E, L", 1, 4, 0, inst_ld_r8_r8},
    [0x5E] = {"LD E, (HL)", 1, 8, 0, inst_ld_r8_r8},
    [0x5F] = {"LD E, A", 1, 4, 0, inst_ld_r8_r8},
    
    // 0x60-0x6F - LD r, r
    [0x60] = {"LD H, B", 1, 4, 0, inst_ld_r8_r8},
    [0x61] = {"LD H, C", 1, 4, 0, inst_ld_r8_r8},
    [0x62] = {"LD H, D", 1, 4, 0, inst_ld_r8_r8},
    [0x63] = {"LD H, E", 1, 4, 0, inst_ld_r8_r8},
    [0x64] = {"LD H, H", 1, 4, 0, inst_ld_r8_r8},
    [0x65] = {"LD H, L", 1, 4, 0, inst_ld_r8_r8},
    [0x66] = {"LD H, (HL)", 1, 8, 0, inst_ld_r8_r8},
    [0x67] = {"LD H, A", 1, 4, 0, inst_ld_r8_r8},
    [0x68] = {"LD L, B", 1, 4, 0, inst_ld_r8_r8},
    [0x69] = {"LD L, C", 1, 4, 0, inst_ld_r8_r8},
    [0x6A] = {"LD L, D", 1, 4, 0, inst_ld_r8_r8},
    [0x6B] = {"LD L, E", 1, 4, 0, inst_ld_r8_r8},
    [0x6C] = {"LD L, H", 1, 4, 0, inst_ld_r8_r8},
    [0x6D] = {"LD L, L", 1, 4, 0, inst_ld_r8_r8},
    [0x6E] = {"LD L, (HL)", 1, 8, 0, inst_ld_r8_r8},
    [0x6F] = {"LD L, A", 1, 4, 0, inst_ld_r8_r8},
    
    // 0x70-0x7F - LD r, r
    [0x70] = {"LD (HL), B", 1, 8, 0, inst_ld_r8_r8},
    [0x71] = {"LD (HL), C", 1, 8, 0, inst_ld_r8_r8},
    [0x72] = {"LD (HL), D", 1, 8, 0, inst_ld_r8_r8},
    [0x73] = {"LD (HL), E", 1, 8, 0, inst_ld_r8_r8},
    [0x74] = {"LD (HL), H", 1, 8, 0, inst_ld_r8_r8},
    [0x75] = {"LD (HL), L", 1, 8, 0, inst_ld_r8_r8},
    [0x76] = {"HALT", 1, 4, 0, inst_halt},
    [0x77] = {"LD (HL), A", 1, 8, 0, inst_ld_r8_r8},
    [0x78] = {"LD A, B", 1, 4, 0, inst_ld_r8_r8},
    [0x79] = {"LD A, C", 1, 4, 0, inst_ld_r8_r8},
    [0x7A] = {"LD A, D", 1, 4, 0, inst_ld_r8_r8},
    [0x7B] = {"LD A, E", 1, 4, 0, inst_ld_r8_r8},
    [0x7C] = {"LD A, H", 1, 4, 0, inst_ld_r8_r8},
    [0x7D] = {"LD A, L", 1, 4, 0, inst_ld_r8_r8},
    [0x7E] = {"LD A, (HL)", 1, 8, 0, inst_ld_r8_r8},
    [0x7F] = {"LD A, A", 1, 4, 0, inst_ld_r8_r8},
    
    // 0x80-0x8F - ADD/ADC/SUB/SBC/AND/XOR/OR/CP
    [0x80] = {"ADD A, B", 1, 4, 0, inst_add_a_r8},
    [0x81] = {"ADD A, C", 1, 4, 0, inst_add_a_r8},
    [0x82] = {"ADD A, D", 1, 4, 0, inst_add_a_r8},
    [0x83] = {"ADD A, E", 1, 4, 0, inst_add_a_r8},
    [0x84] = {"ADD A, H", 1, 4, 0, inst_add_a_r8},
    [0x85] = {"ADD A, L", 1, 4, 0, inst_add_a_r8},
    [0x86] = {"ADD A, (HL)", 1, 8, 0, inst_add_a_hl},
    [0x87] = {"ADD A, A", 1, 4, 0, inst_add_a_r8},
    [0x88] = {"ADC A, B", 1, 4, 0, inst_adc_a_r8},
    [0x89] = {"ADC A, C", 1, 4, 0, inst_adc_a_r8},
    [0x8A] = {"ADC A, D", 1, 4, 0, inst_adc_a_r8},
    [0x8B] = {"ADC A, E", 1, 4, 0, inst_adc_a_r8},
    [0x8C] = {"ADC A, H", 1, 4, 0, inst_adc_a_r8},
    [0x8D] = {"ADC A, L", 1, 4, 0, inst_adc_a_r8},
    [0x8E] = {"ADC A, (HL)", 1, 8, 0, inst_adc_a_hl},
    [0x8F] = {"ADC A, A", 1, 4, 0, inst_adc_a_r8},
    
    // 0x90-0x9F - SUB/SBC/AND/XOR/OR/CP
    [0x90] = {"SUB A, B", 1, 4, 0, inst_sub_a_r8},
    [0x91] = {"SUB A, C", 1, 4, 0, inst_sub_a_r8},
    [0x92] = {"SUB A, D", 1, 4, 0, inst_sub_a_r8},
    [0x93] = {"SUB A, E", 1, 4, 0, inst_sub_a_r8},
    [0x94] = {"SUB A, H", 1, 4, 0, inst_sub_a_r8},
    [0x95] = {"SUB A, L", 1, 4, 0, inst_sub_a_r8},
    [0x96] = {"SUB A, (HL)", 1, 8, 0, inst_sub_a_hl},
    [0x97] = {"SUB A, A", 1, 4, 0, inst_sub_a_r8},
    [0x98] = {"SBC A, B", 1, 4, 0, inst_sbc_a_r8},
    [0x99] = {"SBC A, C", 1, 4, 0, inst_sbc_a_r8},
    [0x9A] = {"SBC A, D", 1, 4, 0, inst_sbc_a_r8},
    [0x9B] = {"SBC A, E", 1, 4, 0, inst_sbc_a_r8},
    [0x9C] = {"SBC A, H", 1, 4, 0, inst_sbc_a_r8},
    [0x9D] = {"SBC A, L", 1, 4, 0, inst_sbc_a_r8},
    [0x9E] = {"SBC A, (HL)", 1, 8, 0, inst_sbc_a_hl},
    [0x9F] = {"SBC A, A", 1, 4, 0, inst_sbc_a_r8},
    
    // 0xA0-0xAF - AND/XOR/OR/CP
    [0xA0] = {"AND A, B", 1, 4, 0, inst_and_a_r8},
    [0xA1] = {"AND A, C", 1, 4, 0, inst_and_a_r8},
    [0xA2] = {"AND A, D", 1, 4, 0, inst_and_a_r8},
    [0xA3] = {"AND A, E", 1, 4, 0, inst_and_a_r8},
    [0xA4] = {"AND A, H", 1, 4, 0, inst_and_a_r8},
    [0xA5] = {"AND A, L", 1, 4, 0, inst_and_a_r8},
    [0xA6] = {"AND A, (HL)", 1, 8, 0, inst_and_a_hl},
    [0xA7] = {"AND A, A", 1, 4, 0, inst_and_a_r8},
    [0xA8] = {"XOR A, B", 1, 4, 0, inst_xor_a_r8},
    [0xA9] = {"XOR A, C", 1, 4, 0, inst_xor_a_r8},
    [0xAA] = {"XOR A, D", 1, 4, 0, inst_xor_a_r8},
    [0xAB] = {"XOR A, E", 1, 4, 0, inst_xor_a_r8},
    [0xAC] = {"XOR A, H", 1, 4, 0, inst_xor_a_r8},
    [0xAD] = {"XOR A, L", 1, 4, 0, inst_xor_a_r8},
    [0xAE] = {"XOR A, (HL)", 1, 8, 0, inst_xor_a_hl},
    [0xAF] = {"XOR A, A", 1, 4, 0, inst_xor_a_r8},
    
    // 0xB0-0xBF - OR/CP
    [0xB0] = {"OR A, B", 1, 4, 0, inst_or_a_r8},
    [0xB1] = {"OR A, C", 1, 4, 0, inst_or_a_r8},
    [0xB2] = {"OR A, D", 1, 4, 0, inst_or_a_r8},
    [0xB3] = {"OR A, E", 1, 4, 0, inst_or_a_r8},
    [0xB4] = {"OR A, H", 1, 4, 0, inst_or_a_r8},
    [0xB5] = {"OR A, L", 1, 4, 0, inst_or_a_r8},
    [0xB6] = {"OR A, (HL)", 1, 8, 0, inst_or_a_hl},
    [0xB7] = {"OR A, A", 1, 4, 0, inst_or_a_r8},
    [0xB8] = {"CP A, B", 1, 4, 0, inst_cp_a_r8},
    [0xB9] = {"CP A, C", 1, 4, 0, inst_cp_a_r8},
    [0xBA] = {"CP A, D", 1, 4, 0, inst_cp_a_r8},
    [0xBB] = {"CP A, E", 1, 4, 0, inst_cp_a_r8},
    [0xBC] = {"CP A, H", 1, 4, 0, inst_cp_a_r8},
    [0xBD] = {"CP A, L", 1, 4, 0, inst_cp_a_r8},
    [0xBE] = {"CP A, (HL)", 1, 8, 0, inst_cp_a_hl},
    [0xBF] = {"CP A, A", 1, 4, 0, inst_cp_a_r8},
    
    // 0xC0-0xCF - RET/CALL/JP
    [0xC0] = {"RET NZ", 1, 20, 8, inst_ret_nz},
    [0xC1] = {"POP BC", 1, 12, 0, inst_pop_bc},
    [0xC2] = {"JP NZ, nn", 3, 16, 12, inst_jp_nz_n16},
    [0xC3] = {"JP nn", 3, 16, 0, inst_jp_n16},
    [0xC4] = {"CALL NZ, nn", 3, 24, 12, inst_call_nz_n16},
    [0xC5] = {"PUSH BC", 1, 16, 0, inst_push_bc},
    [0xC6] = {"ADD A, n", 2, 8, 0, inst_add_a_n8},
    [0xC7] = {"RST 00H", 1, 16, 0, inst_rst_00h},
    [0xC8] = {"RET Z", 1, 20, 8, inst_ret_z},
    [0xC9] = {"RET", 1, 16, 0, inst_ret},
    [0xCA] = {"JP Z, nn", 3, 16, 12, inst_jp_z_n16},
    [0xCB] = {"PREFIX CB", 1, 4, 0, inst_cb_prefix}, // Géré séparément
    [0xCC] = {"CALL Z, nn", 3, 24, 12, inst_call_z_n16},
    [0xCD] = {"CALL nn", 3, 24, 0, inst_call_n16},
    [0xCE] = {"ADC A, n", 2, 8, 0, inst_adc_a_n8},
    [0xCF] = {"RST 08H", 1, 16, 0, inst_rst_08h},
    
    // 0xD0-0xDF - RET/CALL/JP
    [0xD0] = {"RET NC", 1, 20, 8, inst_ret_nc},
    [0xD1] = {"POP DE", 1, 12, 0, inst_pop_de},
    [0xD2] = {"JP NC, nn", 3, 16, 12, inst_jp_nc_n16},
    [0xD3] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xD4] = {"CALL NC, nn", 3, 24, 12, inst_call_nc_n16},
    [0xD5] = {"PUSH DE", 1, 16, 0, inst_push_de},
    [0xD6] = {"SUB A, n", 2, 8, 0, inst_sub_a_n8},
    [0xD7] = {"RST 10H", 1, 16, 0, inst_rst_10h},
    [0xD8] = {"RET C", 1, 20, 8, inst_ret_c},
    [0xD9] = {"RETI", 1, 16, 0, inst_reti},
    [0xDA] = {"JP C, nn", 3, 16, 12, inst_jp_c_n16},
    [0xDB] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xDC] = {"CALL C, nn", 3, 24, 12, inst_call_c_n16},
    [0xDD] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xDE] = {"SBC A, n", 2, 8, 0, inst_sbc_a_n8},
    [0xDF] = {"RST 18H", 1, 16, 0, inst_rst_18h},
    
    // 0xE0-0xEF - LDH/JP
    [0xE0] = {"LDH (n), A", 2, 12, 0, inst_ldh_imm8_a},
    [0xE1] = {"POP HL", 1, 12, 0, inst_pop_hl},
    [0xE2] = {"LD (C), A", 1, 8, 0, inst_ldh_c_a},
    [0xE3] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xE4] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xE5] = {"PUSH HL", 1, 16, 0, inst_push_hl},
    [0xE6] = {"AND A, n", 2, 8, 0, inst_and_a_n8},
    [0xE7] = {"RST 20H", 1, 16, 0, inst_rst_20h},
    [0xE8] = {"ADD SP, e", 2, 16, 0, inst_add_sp_e8},
    [0xE9] = {"JP (HL)", 1, 4, 0, inst_jp_hl},
    [0xEA] = {"LD (nn), A", 3, 16, 0, inst_ld_imm16_a},
    [0xEB] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xEC] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xED] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xEE] = {"XOR A, n", 2, 8, 0, inst_xor_a_n8},
    [0xEF] = {"RST 28H", 1, 16, 0, inst_rst_28h},
    
    // 0xF0-0xFF - LDH/DI/EI
    [0xF0] = {"LDH A, (n)", 2, 12, 0, inst_ldh_a_imm8},
    [0xF1] = {"POP AF", 1, 12, 0, inst_pop_af},
    [0xF2] = {"LD A, (C)", 1, 8, 0, inst_ldh_a_c},
    [0xF3] = {"DI", 1, 4, 0, inst_di},
    [0xF4] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xF5] = {"PUSH AF", 1, 16, 0, inst_push_af},
    [0xF6] = {"OR A, n", 2, 8, 0, inst_or_a_n8},
    [0xF7] = {"RST 30H", 1, 16, 0, inst_rst_30h},
    [0xF8] = {"LD HL, SP+e", 2, 12, 0, inst_ld_hl_sp_e8},
    [0xF9] = {"LD SP, HL", 1, 8, 0, inst_ld_sp_hl},
    [0xFA] = {"LD A, (nn)", 3, 16, 0, inst_ld_a_imm16},
    [0xFB] = {"EI", 1, 4, 0, inst_ei},
    [0xFC] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xFD] = {"ILLEGAL", 1, 0, 0, NULL}, // Illégal
    [0xFE] = {"CP A, n", 2, 8, 0, inst_cp_a_n8},
    [0xFF] = {"RST 38H", 1, 16, 0, inst_rst_38h}
};

// Table d'opcodes CB (préfixe 0xCB) - Définie dans cpu_tables_cb.c
extern const Instruction opcodes_cb[256];
